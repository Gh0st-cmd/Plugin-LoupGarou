# ================================
# FICHIER: .github/workflows/gradle-publish.yml
# GitHub Actions pour build automatique avec Gradle
# ================================

name: Build Plugin Loup-Garou (Gradle)

# DÃ©clencher l'action sur push, pull request et release
on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]
  release:
    types: [created]

jobs:
  build:
    name: Build et Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. Checkout du code
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2. Rendre le wrapper Gradle exÃ©cutable
      - name: âš¡ Make Gradle wrapper executable
        run: chmod +x ./gradlew

      # 3. Configuration de Java 21
      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # 4. Build avec Gradle
      - name: ğŸ—ï¸ Build with Gradle
        run: ./gradlew clean shadowJar --no-daemon

      # 5. Lister les fichiers gÃ©nÃ©rÃ©s
      - name: ğŸ“‹ List build artifacts
        run: ls -la build/libs/

      # 6. Upload du JAR comme artifact
      - name: ğŸ“¤ Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: LoupGarou-Plugin
          path: build/libs/*.jar
          retention-days: 30

      # 7. Tests (optionnel)
      - name: ğŸ§ª Run tests
        run: ./gradlew test
        continue-on-error: true

      # 8. Upload des rÃ©sultats de tests
      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: build/test-results/
          retention-days: 7

  # Job de release automatique
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
      # 1. Checkout du code
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # 2. Rendre le wrapper Gradle exÃ©cutable
      - name: âš¡ Make Gradle wrapper executable
        run: chmod +x ./gradlew

      # 3. Configuration de Java 21
      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # 4. Build
      - name: ğŸ—ï¸ Build with Gradle
        run: ./gradlew clean shadowJar --no-daemon

      # 5. TÃ©lÃ©charger l'artifact
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: LoupGarou-Plugin

      # 6. Upload vers GitHub Release
      - name: ğŸš€ Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/libs/*.jar
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## ğŸº Plugin Loup-Garou ${{ github.ref_name }}
            
            ### ğŸ“¥ Installation
            1. TÃ©lÃ©chargez le fichier `.jar` ci-dessous
            2. Placez-le dans le dossier `plugins/` de votre serveur
            3. RedÃ©marrez le serveur
            4. Utilisez `/lg aide` pour commencer !
            
            ### âœ¨ Changements
            Voir le [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
            
            ### ğŸŒ CompatibilitÃ©
            - Minecraft 1.21.8+
            - Spigot/Paper
            - Java 21+
            
            ### ğŸ“– Documentation
            [Wiki](https://github.com/${{ github.repository }}/wiki) â€¢ [Discord](#)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
