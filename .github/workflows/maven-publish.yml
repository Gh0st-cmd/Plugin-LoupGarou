# ================================
# FICHIER: .github/workflows/maven-publish.yml
# GitHub Actions pour build automatique avec Maven
# ================================

name: Build Plugin Loup-Garou (Maven)

# DÃ©clencher l'action sur push et pull request
on:
  push:
    branches: [ "main", "master", "develop" ]
  pull_request:
    branches: [ "main", "master" ]
  release:
    types: [created]

jobs:
  build:
    name: Build et Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    # 1. Checkout du code
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    # 2. Configuration de Java 17
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # 3. Build avec Maven
    - name: ğŸ—ï¸ Build with Maven
      run: mvn clean package --batch-mode --update-snapshots

    # 4. Lister les fichiers gÃ©nÃ©rÃ©s
    - name: ğŸ“‹ List build artifacts
      run: ls -la target/

    # 5. Upload du fichier JAR comme artifact
    - name: ğŸ“¤ Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: LoupGarou-Plugin
        path: target/*.jar
        retention-days: 30

    # 6. Tests
    - name: ğŸ§ª Run tests
      run: mvn test --batch-mode
      continue-on-error: true

    # 7. Upload des rÃ©sultats de tests
    - name: ğŸ“Š Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: target/surefire-reports/
        retention-days: 7

  # Job de release automatique
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
    # 1. Checkout du code
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    # 2. Configuration de Java
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Build
    - name: ğŸ—ï¸ Build with Maven
      run: mvn clean package --batch-mode

    # 4. TÃ©lÃ©charger l'artifact
    - name: ğŸ“¥ Download artifact
      uses: actions/download-artifact@v4
      with:
        name: LoupGarou-Plugin

    # 5. Upload vers GitHub Release
    - name: ğŸš€ Upload Release Asset
      uses: softprops/action-gh-release@v1
      with:
        files: |
          target/*.jar
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸº Plugin Loup-Garou ${{ github.ref_name }}
          
          ### ğŸ“¥ Installation
          1. TÃ©lÃ©chargez le fichier `.jar` ci-dessous
          2. Placez-le dans le dossier `plugins/` de votre serveur
          3. RedÃ©marrez le serveur
          4. Utilisez `/lg aide` pour commencer !
          
          ### âœ¨ Changements
          Voir le [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          
          ### ğŸŒ CompatibilitÃ©
          - Minecraft 1.21.8+
          - Spigot/Paper
          - Java 17+
          
          ### ğŸ“– Documentation
          [Wiki](https://github.com/${{ github.repository }}/wiki) â€¢ [Discord](#)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
