// ================================
// FICHIER: build.gradle
// Configuration Gradle pour le plugin Loup-Garou
// ================================

plugins {
    id 'java'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
}

group = 'fr.loupgarou'
version = '1.0.1'
description = 'Plugin Loup-Garou pour Minecraft'

java {
    toolchain {
        languageVersion.set(JavaLanguageVersion.of(17))
    }
}

repositories {
    mavenCentral()

    // Repositories Minecraft
    maven { name = 'spigotmc-repo'; url = 'https://hub.spigotmc.org/nexus/content/repositories/snapshots/' }
    maven { name = 'papermc'; url = 'https://repo.papermc.io/repository/maven-public/' }
    maven { name = 'sk89q-repo'; url = 'https://maven.enginehub.org/repo/' }
}

dependencies {
    // Paper API
    compileOnly 'io.papermc.paper:paper-api:1.21.1-R0.1-SNAPSHOT'

    // WorldGuard (optionnel)
    compileOnly 'com.sk89q.worldguard:worldguard-bukkit:7.0.9'

    // Spigot API alternative
    // compileOnly 'org.spigotmc:spigot-api:1.21.1-R0.1-SNAPSHOT'
}

// ------------------------
// Compilation et encoding
// ------------------------
tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
    options.compilerArgs.addAll(['-Xlint:deprecation', '-Xlint:unchecked'])
}

// ------------------------
// Traitement plugin.yml
// ------------------------
tasks.processResources {
    filteringCharset = 'UTF-8'
    filesMatching('plugin.yml') {
        expand(
                'version': project.version,
                'name': project.name,
                'description': project.description
        )
    }
}

// ------------------------
// Configuration du JAR
// ------------------------
tasks.jar {
    archiveBaseName.set('LoupGarou')
    archiveVersion.set(project.version)
    archiveClassifier.set('')

    manifest {
        attributes(
                'Built-By': System.getProperty('user.name'),
                'Build-Timestamp': new Date().format('yyyy-MM-dd HH:mm:ss'),
                'Created-By': "Gradle ${gradle.gradleVersion}",
                'Build-Jdk': "${System.getProperty('java.version')} (${System.getProperty('java.vendor')} ${System.getProperty('java.vm.version')})",
                'Implementation-Title': project.name,
                'Implementation-Version': project.version
        )
    }
}

// ------------------------
// Shadow JAR (Fat JAR)
// ------------------------
tasks.shadowJar {
    archiveBaseName.set('LoupGarou')
    archiveVersion.set(project.version)
    archiveClassifier.set('')

    // Minimiser le JAR (attention avec les plugins Bukkit/Paper)
    minimize()
}

// ------------------------
// Nettoyage
// ------------------------
tasks.clean {
    delete 'build'
}

// ------------------------
// Affichage des infos de build
// ------------------------
tasks.register('buildInfo') {
    doLast {
        println ''
        println '╔════════════════════════════════════════╗'
        println '║     Plugin Loup-Garou Build Info      ║'
        println '╚════════════════════════════════════════╝'
        println "  Nom:         ${project.name}"
        println "  Version:     ${project.version}"
        println "  Description: ${project.description}"
        println "  Java:        ${java.toolchain.languageVersion.get()}"
        println "  Gradle:      ${gradle.gradleVersion}"
        println '═══════════════════════════════════════════'
        println ''
    }
}
tasks.build {
    dependsOn tasks.named('buildInfo')
}

// ------------------------
// Tests
// ------------------------
tasks.test {
    useJUnitPlatform()
    testLogging {
        events 'passed', 'skipped', 'failed'
        exceptionFormat 'full'
        showStandardStreams = false
    }
}

// ------------------------
// Copier le JAR vers serveur test
// ------------------------
tasks.register('copyToServer', Copy) {
    dependsOn tasks.shadowJar
    from tasks.shadowJar.flatMap { it.archiveFile }
    into file('../test-server/plugins/') // Ajuster selon votre serveur
    doLast {
        println "✅ Plugin copié vers le serveur de test !"
    }
}

// ------------------------
// Messages de build
// ------------------------
gradle.buildFinished {
    println ''
    println '╔════════════════════════════════════════╗'
    println '║        Build terminé avec succès !     ║'
    println '╚════════════════════════════════════════╝'
    println "  📦 Fichier JAR: build/libs/LoupGarou-${version}.jar"
    println '  🎮 Installation:'
    println '     1. Copiez le JAR dans plugins/'
    println '     2. Redémarrez le serveur'
    println '     3. Utilisez /lg aide'
    println '═══════════════════════════════════════════'
    println ''
}
